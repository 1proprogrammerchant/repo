# Maintainer: Lukas Fleischer <lfleischer@archlinux.org>
# Contributor: Hilton Medeiros <medeiros.hilton@gmail.com>
# Contributor: Dave Reisner <d@falconindy.com>

pkgname=libgit2-julia
pkgver=1.6.3
pkgrel=1
epoch=1
pkgdesc="A linkable library for Git"
arch=(i686 x86_64 armv7h aarch64)
url="https://libgit2.github.com/"
license=(GPL2)
depends=(glibc http-parser pcre zlib libcrypto.so libssl.so)
makedepends=(cmake libssh2 python)
provides=(libgit2.so "libgit2=$epoch:$pkgver")
conflicts=(libgit2)
options=(debug !strip)
source=(
  libgit2-$pkgver.tar.gz::https://github.com/libgit2/libgit2/archive/v${pkgver}.tar.gz
  libgit2-agent-nonfatal.patch)
sha512sums=('5a390030395d5e00217ca3229ff1374f064b41c7c14c332618778af7067c378bca5ffee5c072ad144a71126f7e8cfcd770746b6af8eccf086c8a8b8afa1733f1'
            '98cef8eadbb0b3497d005d8b5dfbb9ce8443e57c8388fb1ef7f8ec7bfeaacad701ce2be6a0f927b659cd5a77a51da75b85133a07b0810aacdc19b2c141351b49')
b2sums=('c0a588e962c182c09b91e257760484bc0ebf2ab07fdd89b7b90db1dd6749d7fb65b8e3fcd20e8a46a6381038aeac8759161dc409be36eadc776a55d74290e59c'
        'f6efe5aa17a595be0d9871c3aad994229aae3481c7999f5e18a000d2ee3753446df619b121194babb012c5a47862bb14bf282b6069f0e4f3edb9bc32c0eec4ab')

prepare() {
  cd "libgit2-$pkgver"
  mkdir -p build
  patch -p1 < ../libgit2-agent-nonfatal.patch
}


build() {
  cd "libgit2-$pkgver"
  export LANG=en_US.UTF-8
  CFLAGS+=" -ffile-prefix-map=${srcdir}=${DBGSRCDIR:-/usr/src/debug}"
  CXXFLAGS+=" -ffile-prefix-map=${srcdir}=${DBGSRCDIR:-/usr/src/debug}"
  export CFLAGS+=' -g'
  export CXXFLAGS+=' -g'
  cmake -DCMAKE_INSTALL_PREFIX=/usr \
        -DCMAKE_BUILD_TYPE=Release \
        -DUSE_HTTP_PARSER=system \
        -DUSE_SSH=ON \
        -DTHREADSAFE=ON \
        -Wno-dev \
        -B build \
        -S .
  make -C build
}

package() {
  depends+=(libssh2.so)

  cd "libgit2-$pkgver"
  make -C build DESTDIR="$pkgdir" install
  install -vDm 644 {AUTHORS,README.md} -t "${pkgdir}/usr/share/doc/libgit2"
}
