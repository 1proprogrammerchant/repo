# Maintainer: Levente Polyak <anthraxx[at]archlinux[dot]org>
# Maintainer: Pierre Schmitz <pierre@archlinux.de>

_pkgname=devtools
pkgname=devtools-archlinuxcn
pkgver=20220207
pkgrel=2
pkgdesc='Tools for Arch Linux package maintainers, archlinuxcn fork'
arch=('any')
license=('GPL')
url='https://gitlab.archlinux.org/archlinux/devtools'
depends=('bash' 'openssh' 'subversion' 'rsync' 'arch-install-scripts'
         'git' 'bzr' 'mercurial' 'diffutils' 'util-linux' 'awk')
makedepends=('asciidoc')
optdepends=('btrfs-progs: btrfs support')
provides=("devtools=$pkgver-$pkgrel")
conflicts=("devtools")
source=(${url}/uploads/1b4a7f5876d24a4d26370f4f81d8f636/devtools-${pkgver}.tar.gz
        ${url}/uploads/070f070114e57b8111f0afe72f2c1585/devtools-${pkgver}.tar.gz.sig
        makepkg.conf-set-LTOFLAGS-flto-auto.patch
        "no-yes-y.patch"
        "unshare-pacstrap.patch"
        "arch-nspawn-read-CacheDir-from-host.patch")
validpgpkeys=('487EACC08557AD082088DABA1EB2638FF56C0C53'
              '4AA4767BBC9C4B1D18AE28B77F2D434B9741E8AC'
              '86CFFCA918CF3AF47147588051E8B148A9999C34'
              '8FC15A064950A99DD1BD14DD39E4B877E62EB915'
              '8218F88849AAC522E94CF470A5E9288C4FA415FA'
              'B81B051F2D7FC867AAFF35A58DBD63B82072D77A'
              'F3691687D867B81B51CE07D9BBE43771487328A9'
              '6645B0A8C7005E78DB1D7864F99FFE0FEAE999BD'
              'E240B57E2C4630BA768E2F26FC1B547C8D8172C8')
sha256sums=('189716b7041057554d6d7ffed0cd05184f5fb03c67c8d12b74b0771df2dbf828'
            'SKIP'
            '1bd579ad29943b54c3a60b93369c5185bdac670cd01440a3ca7b43f64145230c'
            '483fc988fa3c81fa95da99273ccfdc6d4db2f5ceb093a2f7e3789870d18beb82'
            '9913e92ed92b10e1538b2e683da9a295283a0777d2a22726a5f27d4c6c29b7e0'
            'f7f8fa6f3bf5e4cdc58a8616c4efd8c2e21757457f5d307a839f3e7dd7d95a0b')
b2sums=('334c434868f3769765b8e05cde1b825433322725247d6cb1509993cca980a2f02a55c763b0e4d6bd53988bb4630d86785ccbe636b842e7103c93a43d1036e36f'
        'SKIP'
        '4eea243b9152c38d1e82f0f6abd02fdbb69c9640fd7bef528532ccb0b978a1f0e39d0e2c985a9bd2dd26d2d8242ecb6b5b7f2085f0c62f521e65d487b7d1452d'
        '2da933aa8a0bce8acab22fcbdf857462a28bb313e4554b73cf4cb02dafb40ad124b71e5666cd88257dee8a1721a57e6659581026ab2ff21aa2c257df2397db0c'
        'ad659b04b7b7a9111ceace6629e971ef775e73a2b68a82dc13d3dd5b732f3e7a056b3328fab54fa6b16e520212e4b5a6d5d27e1b0b87d10495c89a17ff130fc5'
        'e0e3e41fcfcc331140b5bb57dbcab7ad96e5eefc92ae371e6c4e378d2cf65f669e8d92d2bbb02990ab67d2b83d28cd41b92380461b60f43512dec7e25417fd01')

prepare() {
  cd ${_pkgname}-${pkgver}
  # https://gitlab.archlinux.org/archlinux/devtools/-/merge_requests/92
  patch -Np1 -i ../makepkg.conf-set-LTOFLAGS-flto-auto.patch
  patch -RNp1 -i ../no-yes-y.patch
  patch -Np1 -i ../unshare-pacstrap.patch
  # https://gitlab.archlinux.org/archlinux/devtools/-/merge_requests/95
  patch -Np1 -i ../arch-nspawn-read-CacheDir-from-host.patch

  ## silent while show errors for curl
  sed "s|bin/curl -qg|bin/curl -qSsg|g" -i makepkg-x86_64.conf
}

build() {
  cd ${_pkgname}-${pkgver}
  make BUILDTOOLVER="${pkgver}-${pkgrel}-${arch}" PREFIX=/usr
}

package() {
  cd ${_pkgname}-${pkgver}
  make PREFIX=/usr DESTDIR="${pkgdir}" install
}

# vim: ts=2 sw=2 et:
