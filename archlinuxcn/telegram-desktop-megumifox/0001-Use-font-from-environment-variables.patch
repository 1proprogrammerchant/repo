From e8b0eeda4dff1482d1e7520c44fcec7a87266e0a Mon Sep 17 00:00:00 2001
From: Megumi_fox <i@megumifox.com>
Date: Thu, 22 Jun 2023 18:31:34 +0800
Subject: [PATCH] Use font from environment variables

Signed-off-by: Megumi_fox <i@megumifox.com>
---
 ui/style/style_core_custom_font.cpp | 47 +++++++++--------------------
 1 file changed, 14 insertions(+), 33 deletions(-)

diff --git a/ui/style/style_core_custom_font.cpp b/ui/style/style_core_custom_font.cpp
index 8f42baf..cf3f47f 100644
--- a/ui/style/style_core_custom_font.cpp
+++ b/ui/style/style_core_custom_font.cpp
@@ -31,44 +31,25 @@ QFont ResolveFont(const QString &familyOverride, uint32 flags, int size) {
 
 	const auto bold = ((flags & FontBold) || (flags & FontSemibold));
 	const auto italic = (flags & FontItalic);
-	const auto &custom = bold ? BoldFont : RegularFont;
-	const auto useCustom = !custom.family.isEmpty();
+	const QString FontFamilyName = qEnvironmentVariable("TELEGRAM_DESKTOP_UI_FONT");
+	const QString FontFamilyNameMono = qEnvironmentVariable("TELEGRAM_DESKTOP_UI_FONT_MONO");
+	const QString FontFamilyBoldStyle = qEnvironmentVariable("TELEGRAM_DESKTOP_UI_FONT_BOLD_STYLE");
+	auto result = QFont(FontFamilyName.isEmpty() ? QGuiApplication::font().family() : FontFamilyName);
 
-	auto result = QFont(QGuiApplication::font().family());
-	if (!familyOverride.isEmpty()) {
-		result.setFamily(familyOverride);
-		if (bold) {
-			result.setBold(true);
-		}
-	} else if (flags & FontMonospace) {
-		result.setFamily(MonospaceFont());
-	} else if (useCustom) {
-		const auto sizes = Database.smoothSizes(custom.family, custom.style);
-		const auto good = sizes.isEmpty()
-			? Database.pointSizes(custom.family, custom.style)
-			: sizes;
-		const auto point = good.isEmpty() ? size : good.front();
-		result = Database.font(custom.family, custom.style, point);
-	} else {
-		result.setFamily(GetFontOverride(flags));
-		if (bold) {
-#ifdef DESKTOP_APP_USE_PACKAGED_FONTS
-			result.setWeight(QFont::DemiBold);
-#else // DESKTOP_APP_USE_PACKAGED_FONTS
-			result.setBold(true);
-#endif // !DESKTOP_APP_USE_PACKAGED_FONTS
 
-			if (flags & FontItalic) {
-				result.setStyleName("Semibold Italic");
-			} else {
-				result.setStyleName("Semibold");
-			}
-		}
+	if (flags & FontMonospace){
+		result.setFamily(FontFamilyNameMono.isEmpty() ? MonospaceFont() : FontFamilyNameMono);
 	}
-	if (italic) {
-		result.setItalic(true);
+
+	if (bold) {
+		if (FontFamilyBoldStyle.isEmpty()){
+			result.setWeight(QFont::Medium);
+		} else {
+			result.setStyleName(FontFamilyBoldStyle);
+		}
 	}
 
+	result.setItalic(flags & FontItalic);
 	result.setUnderline(flags & FontUnderline);
 	result.setStrikeOut(flags & FontStrikeOut);
 	result.setPixelSize(size);
-- 
2.41.0

